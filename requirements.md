# Структура исходных данных, требования к таблицам миграции и представлению для аналитики

# 1.1 Cтруктурa исходных данных

Исходные данные содержатся в таблице shipping, которая представляет собой последовательность действий при доставке, перечисленную ниже:
	- shippingid — уникальный идентификатор доставки.
	- saleid — уникальный идентификатор заказа. К одному заказу может быть привязано несколько строчек shippingid, то есть логов, с информацией о доставке.
	- vendorid — уникальный идентификатор вендора. К одному вендору может быть привязано множество saleid и множество строк доставки.
	- payment — сумма платежа (то есть дублирующаяся информация).
	- shipping_plan_datetime — плановая дата доставки.
	- status — статус доставки в таблице shipping по данному shippingid. Может принимать значения in_progress — доставка в процессе, либо finished — доставка завершена.
	- state — промежуточные точки заказа, которые изменяются в соответствии с обновлением информации о доставке по времени state_datetime:
	 	- booked (пер. «заказано»);
	 	- fulfillment — заказ доставлен на склад отправки;
	 	- queued (пер. «в очереди») — заказ в очереди на запуск доставки;
	 	- transition (пер. «передача») — запущена доставка заказа;
	 	- pending (пер. «в ожидании») — заказ доставлен в пункт выдачи и ожидает получения;
	 	- received (пер. «получено») — покупатель забрал заказ;
	 	- returned (пер. «возвращено») — покупатель возвратил заказ после того, как его забрал.
	- state_datetime — время обновления состояния заказа.
	- shipping_transfer_description — строка со значениями transfer_type и transfer_model, записанными через :. Пример записи — 1p:car.
	 	- transfer_type — тип доставки. 1p означает, что компания берёт ответственность за доставку на себя, 3p — что за отправку ответственен вендор.
	 	- transfer_model — модель доставки, то есть способ, которым заказ доставляется до точки: car — машиной, train — поездом, ship — кораблем, airplane — самолетом, multiple — комбинированной доставкой.
	- shipping_transfer_rate — процент стоимости доставки для вендора в зависимости от типа и модели доставки, который взимается интернет-магазином для покрытия расходов.
	- shipping_country — страна доставки, учитывая описание тарифа для каждой страны.
	- shipping_country_base_rate — налог на доставку в страну, который является процентом от стоимости payment_amount.
	- vendor_agreement_description — строка, в которой содержатся данные agreementid, agreement_number, agreement_rate, agreement_commission, записанные через разделитель :. Пример записи — 12:vsp-34:0.02:0.023.
	 	- agreementid — идентификатор договора. 
	 	- agreement_number — номер договора в бухгалтерии. 
	 	- agreement_rate — ставка налога за стоимость доставки товара для вендора. 
	 	- agreement_commission — комиссия, то есть доля в платеже являющаяся доходом компании от сделки.

#### Особенности данных:
- Порядка 2% заказов исполняется с просрочкой, и это норма для вендоров. 
	Вендор №3, у которого этот процент достигает 10%, скорее всего неблагонадёжен.
- Около 2% заказов не доходят до клиентов.
- В пределах нормы и то, что порядка 1.5% заказов возвращаются клиентами. При этом у вендора №21 50% возвратов.
	Он торгует электроникой и ноутбуками — очевидно, в его товарах много брака и стоит его изучить.

# 1.2 Требования к таблицам миграции

1.2.1 Справочник стоимости доставки в страны shipping_country_rates должен быть построен из данных, указанных в shipping_country и shipping_country_base_rate. 
Первичный ключ таблицы — серийный id, то есть серийный идентификатор каждой строчки. 
Серийному ключу задать имя «id». 
Справочник должен состоять из уникальных пар полей из таблицы shipping.

1.2.2 Справочник тарифов доставки вендора по договору shipping_agreement построить из данных строки vendor_agreement_description, разделитель :.
Названия полей:
	- agreementid,
	- agreement_number,
	- agreement_rate,
	- agreement_commission.
Первичный ключ = agreementid.

1.2.3 Справочник о типах доставки shipping_transfer должен быть создан из строки shipping_transfer_description через разделитель :.
Названия полей:
	- transfer_type,
	- transfer_model,
	- shipping_transfer_rate .
Первичный ключ — серийный id.

1.2.4 Таблица shipping_info должна содержать уникальные доставки shippingid.
Связана с созданными справочниками shipping_country_rates, shipping_agreement, shipping_transfer 
и содержит константную информацию о доставке shipping_plan_datetime , payment_amount , vendorid.
Первичный ключ — shippingid.
Cвязи с тремя таблицами-справочниками сделать внешними ключами — это обеспечит целостность модели данных и защитит её, если нарушится логика записи в таблицы.

1.2.6 В таблицу статусов о доставке shipping_status должна быть включена информация из лога shipping (status , state). 
Добавить вычислимая информация по фактическому времени доставки shipping_start_fact_datetime, shipping_end_fact_datetime. 
Отразить для каждого уникального shippingid его итоговое состояние доставки, т.е. status и state по максимальному времени лога state_datetime в таблице shipping. 

Уточнения:
	- shipping_start_fact_datetime — это время state_datetime, когда state заказа перешёл в состояние booked.
	- shipping_end_fact_datetime — это время state_datetime, когда state заказа перешёл в состояние received или state по максимальному времени.

# 1.3 Требования к представлению для аналитики

Состав представления:
	- shippingid
	- vendorid
	- transfer_type — тип доставки из таблицы shipping_transfer
	- full_day_at_shipping — количество полных дней, в течение которых длилась доставка. Высчитывается как: shipping_end_fact_datetime-shipping_start_fact_datetime.
	- is_delay — статус, показывающий просрочена ли доставка. Высчитывается как: shipping_end_fact_datetime > shipping_plan_datetime → 1 ; 0
	- is_shipping_finish — статус, показывающий, что доставка завершена. Если финальный status = finished → 1; 0
	- delay_day_at_shipping — количество дней, на которые была просрочена доставка. Высчитыается как: shipping_end_fact_datetime > shipping_plan_datetime → shipping_end_fact_datetime - shipping_plan_datetime ; 0.
	- payment_amount — сумма платежа пользователя
	- vat — итоговый налог на доставку. Высчитывается как: payment_amount * ( shipping_country_base_rate + agreement_rate + shipping_transfer_rate) .
	- profit — итоговый доход компании с доставки. Высчитывается как: payment_amount * agreement_commission.
